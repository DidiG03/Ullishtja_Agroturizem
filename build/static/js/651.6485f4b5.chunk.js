"use strict";(self.webpackChunkullishtja_agroturizem=self.webpackChunkullishtja_agroturizem||[]).push([[651],{1651:(e,t,o)=>{o.r(t),o.d(t,{default:()=>s});var i=o(5043),r=o(9379);const a=new class{constructor(){this.preloadedVideos=new Map,this.preloadQueue=[],this.isPreloading=!1,this.networkInfo=this.getNetworkInfo(),this.deviceInfo=this.getDeviceInfo(),this.userBehavior=this.getUserBehavior(),this.setupNetworkMonitoring(),this.preloadCriticalVideos()}getNetworkInfo(){const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;return e?{effectiveType:e.effectiveType||"4g",downlink:e.downlink||10,rtt:e.rtt||100,saveData:e.saveData||!1}:{effectiveType:"4g",downlink:10,rtt:100,saveData:!1}}getDeviceInfo(){const e=window.innerWidth,t=navigator.deviceMemory||4,o=navigator.hardwareConcurrency||4;return{isMobile:e<=768,isTablet:e>768&&e<=1024,isDesktop:e>1024,memory:t,hardwareConcurrency:o,isLowPower:o<=2||t<=2,pixelRatio:window.devicePixelRatio||1}}getUserBehavior(){const e=localStorage.getItem("video_user_behavior"),t={averageViewTime:3e4,scrollSpeed:"medium",interactionPatterns:[],preferredQuality:"auto",batteryOptimization:!1};return e?(0,r.A)((0,r.A)({},t),JSON.parse(e)):t}setupNetworkMonitoring(){const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;e&&e.addEventListener("change",()=>{this.networkInfo=this.getNetworkInfo(),this.adjustPreloadingStrategy()}),"getBattery"in navigator&&navigator.getBattery().then(e=>{const t=()=>{this.userBehavior.batteryOptimization=e.level<.2||!e.charging};e.addEventListener("levelchange",t),e.addEventListener("chargingchange",t),t()})}adjustPreloadingStrategy(){const{effectiveType:e,saveData:t,downlink:o}=this.networkInfo,{isLowPower:i}=this.deviceInfo,{batteryOptimization:r}=this.userBehavior;t||r||"slow-2g"===e||"2g"===e?this.preloadQueue=[]:("3g"===e||o<5||i)&&(this.preloadQueue=this.preloadQueue.slice(0,2))}getOptimalVideoSource(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"normal";const{isTablet:o,isDesktop:i,isLowPower:r}=this.deviceInfo,{effectiveType:a,downlink:n,saveData:s}=this.networkInfo,{batteryOptimization:d}=this.userBehavior;let l="mobile";!o||r||s||(l="tablet"),i&&!d&&n>5&&(l="desktop"),"slow-2g"===a||"2g"===a?l="mobile":"3g"===a&&"desktop"===l&&(l="tablet");const c=document.createElement("video");let u="mp4";return""!==c.canPlayType("video/webm")&&n>2&&(u="webm"),""!==c.canPlayType('video/webm; codecs="av01.0.05M.08"')&&n>5&&!r&&"high"===t&&(u="av1"),{src:"/videos/".concat(e,"-").concat(l,".").concat("av1"===u?"av1.mp4":u),quality:l,format:u,poster:"/videos/".concat(e,"-poster.jpg")}}async preloadVideo(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"normal";if(this.preloadedVideos.has(e))return this.preloadedVideos.get(e);if(!this.shouldPreload(t))return null;const o=this.getOptimalVideoSource(e,t);try{const t=document.createElement("video");t.preload="metadata",t.muted=!0,t.playsInline=!0;const i=new Promise((e,i)=>{const r=setTimeout(()=>{i(new Error("Preload timeout"))},1e4);t.addEventListener("loadedmetadata",()=>{clearTimeout(r),e({video:t,source:o,preloadedAt:Date.now()})},{once:!0}),t.addEventListener("error",e=>{clearTimeout(r);const t=e.target.error?"Video preload failed: ".concat(e.target.error.message):"Video preload failed for ".concat(o.src);i(new Error(t))},{once:!0})});t.src=o.src;const r=await i;return this.preloadedVideos.set(e,r),this.cleanupOldPreloads(),r}catch(i){return console.warn("Failed to preload video ".concat(e,":"),i.message),null}}shouldPreload(e){const{effectiveType:t,saveData:o,downlink:i}=this.networkInfo,{isLowPower:r}=this.deviceInfo,{batteryOptimization:a}=this.userBehavior;return!o&&"slow-2g"!==t&&"2g"!==t&&(a?"high"===e:r?"high"===e&&i>2:"4g"===t&&i>5||("3g"===t||i>2)&&"low"!==e)}cleanupOldPreloads(){const e=this.deviceInfo.isLowPower?3:6,t=Date.now(),o=Array.from(this.preloadedVideos.entries());if(o.forEach(e=>{let[o,i]=e;t-i.preloadedAt>3e5&&(this.preloadedVideos.delete(o),i.video&&(i.video.src="",i.video.load()))}),this.preloadedVideos.size>e){o.sort((e,t)=>e[1].preloadedAt-t[1].preloadedAt).slice(0,this.preloadedVideos.size-e).forEach(e=>{let[t,o]=e;this.preloadedVideos.delete(t),o.video&&(o.video.src="",o.video.load())})}}async preloadCriticalVideos(){if(!this.shouldPreload("normal"))return;const e=["dji-20240806130059-0020-d","dji-20240806130609-0022-d"].map(async e=>{try{return await this.preloadVideo(e,"high")}catch(t){return console.warn("Failed to preload critical video ".concat(e,":"),t.message),null}});try{await Promise.allSettled(e)}catch(t){console.warn("Some critical videos failed to preload:",t)}}async preloadOnScroll(e,t){if(!this.shouldPreload("normal"))return;const o=t.slice(0,2).map(e=>this.preloadVideo(e,"normal"));await Promise.allSettled(o)}getPreloadedVideo(e){return this.preloadedVideos.get(e)}trackUserInteraction(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=(0,r.A)({timestamp:Date.now(),eventType:e,videoId:t},o);this.userBehavior.interactionPatterns.push(i),this.userBehavior.interactionPatterns.length>100&&(this.userBehavior.interactionPatterns=this.userBehavior.interactionPatterns.slice(-100)),localStorage.setItem("video_user_behavior",JSON.stringify(this.userBehavior))}getPerformanceMetrics(){return{preloadedCount:this.preloadedVideos.size,networkType:this.networkInfo.effectiveType,deviceType:this.deviceInfo.isMobile?"mobile":this.deviceInfo.isTablet?"tablet":"desktop",batteryOptimization:this.userBehavior.batteryOptimization,memoryUsage:.5*this.preloadedVideos.size}}};var n=o(579);const s=e=>{let{src:t,videoId:o,poster:r,fallbackImage:s,alt:d="Video",className:l="",style:c={},autoPlay:u=!0,muted:h=!0,loop:v=!0,playsInline:p=!0,lazy:g=!0,priority:m="normal"}=e;const[f,w]=(0,i.useState)(!1),[y,k]=(0,i.useState)(!g),[P,I]=(0,i.useState)(!1),[b,V]=(0,i.useState)(!1),[T,z]=(0,i.useState)([]),[S,E]=(0,i.useState)(null),O=(0,i.useRef)(null),j=(0,i.useRef)(null);(0,i.useEffect)(()=>{if(o){const e=a.getPreloadedVideo(o);if(e)E(e),z([e.source]);else{const e=a.getOptimalVideoSource(o,m);z([e]),"high"===m&&a.preloadVideo(o,m)}}else t&&z([{src:t,format:"mp4",quality:"unknown"}])},[o,t,m]),(0,i.useEffect)(()=>{const e=new IntersectionObserver(e=>{let[t]=e;const i=t.isIntersecting;if(I(i),o&&i&&a.trackUserInteraction("video_view",o,{viewportPercentage:t.intersectionRatio}),g&&i&&!y&&k(!0),O.current&&f){const e=window.innerWidth<=768;if(i){if(u&&O.current.paused){const t=a.networkInfo,o="3g"===t.effectiveType||t.downlink<3;setTimeout(()=>{if(O.current){const e=O.current.play();void 0!==e&&e.catch(e=>{})}},e?o?200:150:50)}}else if(O.current.paused||O.current.pause(),e){const e=a.deviceInfo,t=e.isLowPower?3:5;if(O.current.currentTime>t&&(O.current.currentTime=0),e.isLowPower)try{O.current.load()}catch(r){}}}},{threshold:window.innerWidth<=768?[.25]:[0,.1,.5],rootMargin:window.innerWidth<=768?"75px 0px":"50px 0px"});return j.current=e,O.current&&e.observe(O.current),()=>{j.current&&j.current.disconnect()}},[g,f,u,o]),(0,i.useEffect)(()=>{if(f&&O.current&&u&&P){const e=O.current.play();void 0!==e&&e.catch(e=>{})}},[f,u,P]);const B=e=>{var t,i,r,n;(console.warn("Video failed to load:",null===(t=e.target)||void 0===t?void 0:t.src),V(!0),o)&&a.trackUserInteraction("video_error",o,{error:(null===(i=e.target)||void 0===i||null===(r=i.error)||void 0===r?void 0:r.message)||"Unknown error",src:null===(n=e.target)||void 0===n?void 0:n.src})};return b?(0,n.jsx)("div",{ref:O,className:"optimized-video-container ".concat(l),style:c,children:(0,n.jsx)("img",{src:s||r,alt:d,className:"video-fallback-image",loading:"lazy"})}):(0,n.jsxs)("div",{ref:O,className:"optimized-video-container ".concat(l),style:c,children:[!f&&r&&(0,n.jsx)("div",{className:"video-poster",children:(0,n.jsx)("img",{src:r,alt:d,className:"poster-image",loading:"lazy"})}),y&&(0,n.jsxs)("video",{ref:O,poster:r,className:"optimized-video ".concat(f?"loaded":"loading"),autoPlay:!1,muted:h,loop:v,playsInline:p,preload:S?"auto":"metadata",onCanPlay:()=>{w(!0),o&&a.trackUserInteraction("video_loaded",o,{loadTime:Date.now()})},onError:B,style:c,children:[T.map((e,t)=>(0,n.jsx)("source",{src:e.src,type:e.type||"video/".concat(e.format),onError:t===T.length-1?B:void 0},t)),(0,n.jsx)("img",{src:s||r,alt:d,className:"video-fallback"})]})]})}}}]);
//# sourceMappingURL=651.6485f4b5.chunk.js.map